const lsKey="ippo_manhwa_v1";let data=[],editIndex=-1,deferredPrompt=null;const el=s=>document.querySelector(s),listEl=el("#list"),emptyEl=el("#empty"),backdrop=el("#backdrop"),modalTitle=el("#modalTitle"),preview=el("#preview"),imgFile=el("#imgFile"),imgUrl=el("#imgUrl"),title=el("#title"),chapter=el("#chapter"),link=el("#link"),btnAdd=el("#btnAdd"),btnExport=el("#btnExport"),btnClear=el("#btnClear"),importFile=el("#importFile"),btnSave=el("#save"),btnCancel=el("#cancel"),btnInstall=el("#btnInstall"),toastEl=el("#toast");function toast(m){toastEl.textContent=m;toastEl.style.display="block";setTimeout(()=>toastEl.style.display="none",1800)}function load(){try{const raw=localStorage.getItem(lsKey);data=raw?JSON.parse(raw):[]}catch(e){data=[]}render()}function save(){localStorage.setItem(lsKey,JSON.stringify(data))}function showModal(edit=false,idx=-1){backdrop.style.display="flex";modalTitle.textContent=edit?"تعديل مانهوا":"إضافة مانهوا";editIndex=edit?idx:-1;if(edit){const it=data[idx];preview.src=it.img||"";imgFile.value="";imgUrl.value="";title.value=it.title||"";chapter.value=it.chapter??"";link.value=it.link||""}else{preview.src="";imgFile.value="";imgUrl.value="";title.value="";chapter.value="";link.value=""}title.focus()}function hideModal(){backdrop.style.display="none"}function readFileAsDataUrl(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}imgFile.addEventListener("change",async()=>{const f=imgFile.files[0];if(!f)return;const url=await readFileAsDataUrl(f);preview.src=url;imgUrl.value=""});imgUrl.addEventListener("input",()=>{preview.src=imgUrl.value||""});function upsertItem(item,idx=-1){if(idx>=0)data[idx]=item;else data.unshift(item);save();render();hideModal()}btnSave.addEventListener("click",()=>{const t=title.value.trim();if(!t){alert("أدخل عنوان المانهوا");title.focus();return}const ch=Number(chapter.value||0);const lk=link.value.trim();const img=preview.src||"";const it={title:t,chapter:isNaN(ch)?0:ch,link:lk,img,addedAt:Date.now()};upsertItem(it,editIndex)});btnCancel.addEventListener("click",hideModal);btnAdd.addEventListener("click",()=>showModal(false));function render(){listEl.innerHTML="";if(!data.length){emptyEl.style.display="block";return}emptyEl.style.display="none";data.forEach((it,i)=>{const card=document.createElement("div");card.className="card";const th=document.createElement("div");th.className="thumb";if(it.img){const img=document.createElement("img");img.src=it.img;th.appendChild(img)}else{th.innerHTML='<div class="muted">لا يوجد غلاف</div>'}const meta=document.createElement("div");meta.className="meta";const ttl=document.createElement("div");ttl.className="title";ttl.textContent=it.title||"(بدون عنوان)";const row1=document.createElement("div");row1.className="row";const kpis=document.createElement("div");kpis.className="kpis";const k1=document.createElement("div");k1.className="kpi";k1.textContent="شابتر: "+(it.chapter??0);kpis.appendChild(k1);const a=document.createElement("a");a.href=it.link||"#";a.target="_blank";a.className="link";a.textContent=it.link?"فتح الرابط":"—";row1.appendChild(kpis);row1.appendChild(a);const actions=document.createElement("div");actions.className="actions";const btnPlus=document.createElement("button");btnPlus.textContent="+1 شابتر";btnPlus.addEventListener("click",()=>{it.chapter=(it.chapter||0)+1;save();render()});const btnEdit=document.createElement("button");btnEdit.className="secondary";btnEdit.textContent="تعديل";btnEdit.addEventListener("click",()=>showModal(true,i));const btnDel=document.createElement("button");btnDel.className="danger";btnDel.textContent="حذف";btnDel.addEventListener("click",()=>{if(confirm("حذف المانهوا؟")){data.splice(i,1);save();render()}});actions.appendChild(btnPlus);actions.appendChild(btnEdit);actions.appendChild(btnDel);meta.appendChild(ttl);meta.appendChild(row1);meta.appendChild(actions);card.appendChild(th);card.appendChild(meta);listEl.appendChild(card)})}btnExport.addEventListener("click",()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="manhwa_backup.json";a.click();URL.revokeObjectURL(a.href)});importFile.addEventListener("change",e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const arr=JSON.parse(r.result);if(Array.isArray(arr)){data=arr;save();render()}else alert("صيغة الملف غير صحيحة")}catch(err){alert("تعذّر قراءة الملف")}};r.readAsText(f)});btnClear.addEventListener("click",()=>{if(confirm("متأكد؟ سيُمسح كل شيء من هذا المتصفح.")){data=[];save();render()}});backdrop.addEventListener("click",e=>{if(e.target===backdrop)hideModal()});window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;btnInstall.style.display="inline-block"});btnInstall.addEventListener("click",async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();const {outcome}=await deferredPrompt.userChoice;deferredPrompt=null;btnInstall.style.display="none";toast(outcome==="accepted"?"تم التثبيت":"تم الإلغاء")});load();